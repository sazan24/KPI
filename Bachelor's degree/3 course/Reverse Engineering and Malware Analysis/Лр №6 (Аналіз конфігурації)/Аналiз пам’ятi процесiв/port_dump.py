#!/bin/env python
import winappdbg
import re

system = winappdbg.System()
system.request_debug_privileges()
system.scan_processes()
for process, path in system.find_processes_by_filename("server_upx.exe"):
    pid = process.get_pid()
    bits = process.get_bits()
    print("pid %d (%d bits)" % (pid, bits))

    memory_map = process.get_memory_map()
    mapped_filenames = process.get_mapped_filenames(memory_map)

    for info_object in memory_map:
        address = info_object.BaseAddress
        filename = mapped_filenames.get(address, None)

        if info_object.has_content():
            print("address 0x%x size 0x%x state 0x%x protect 0x%x type 0x%x [%s]" %
                  (address, info_object.RegionSize, info_object.State, info_object.Protect, info_object.Type, filename))
            text = process.read(address, info_object.RegionSize)
            cleaned_text = text[::2].replace("\x00", "")
            port = re.search(":[1-9][0-9]{3,4}", cleaned_text)
            if port is not None:
                if port.group(0) > ":65535":
                    continue
                else:
                    server_port = port.group(0)
                    print(port.group(0))
                    raw_input()
